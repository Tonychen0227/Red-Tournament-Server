<form action="/admin/complete-race/<%= race._id %>" method="post">
    <div>
        <label for="racer1"><%= race.racer1.displayName || race.racer1.discordUsername %>:</label>
        <select name="results[0][status]" id="racer1-status" required>
            <option value="Finished">Finished</option>
            <option value="DNF">Did Not Finish (DNF)</option>
            <option value="DQ">Disqualified (DQ)</option>
        </select>
        <div id="racer1-time-container">
            <label for="racer1-time">Finish Time:</label>
            <input type="number" name="results[0][finishTime][hours]" placeholder="Hours" min="0" max="2">
            <input type="number" name="results[0][finishTime][minutes]" placeholder="Minutes" min="0" max="59">
            <input type="number" name="results[0][finishTime][seconds]" placeholder="Seconds" min="0" max="59">
            <input type="number" name="results[0][finishTime][milliseconds]" placeholder="Milliseconds" min="0" max="999">
        </div>
        <input type="hidden" name="results[0][racer]" value="<%= race.racer1._id %>">
    </div>

    <% if (race.racer2) { %>
    <div>
        <label for="racer2"><%= race.racer2.displayName || race.racer2.discordUsername %>:</label>
        <select name="results[1][status]" id="racer2-status" required>
            <option value="Finished">Finished</option>
            <option value="DNF">Did Not Finish (DNF)</option>
            <option value="DQ">Disqualified (DQ)</option>
        </select>
        <div id="racer2-time-container">
            <label for="racer2-time">Finish Time:</label>
            <input type="number" name="results[1][finishTime][hours]" placeholder="Hours" min="0" max="2">
            <input type="number" name="results[1][finishTime][minutes]" placeholder="Minutes" min="0" max="59">
            <input type="number" name="results[1][finishTime][seconds]" placeholder="Seconds" min="0" max="59">
            <input type="number" name="results[1][finishTime][milliseconds]" placeholder="Milliseconds" min="0" max="999">
        </div>
        <input type="hidden" name="results[1][racer]" value="<%= race.racer2._id %>">
    </div>
    <% } %>

    <% if (race.racer3) { %>
    <div>
        <label for="racer3"><%= race.racer3.displayName || race.racer3.discordUsername %>:</label>
        <select name="results[2][status]" id="racer3-status" required>
            <option value="Finished">Finished</option>
            <option value="DNF">Did Not Finish (DNF)</option>
            <option value="DQ">Disqualified (DQ)</option>
        </select>
        <div id="racer3-time-container">
            <label for="racer3-time">Finish Time:</label>
            <input type="number" name="results[2][finishTime][hours]" placeholder="Hours" min="0" max="2">
            <input type="number" name="results[2][finishTime][minutes]" placeholder="Minutes" min="0" max="59">
            <input type="number" name="results[2][finishTime][seconds]" placeholder="Seconds" min="0" max="59">
            <input type="number" name="results[2][finishTime][milliseconds]" placeholder="Milliseconds" min="0" max="999">
        </div>
        <input type="hidden" name="results[2][racer]" value="<%= race.racer3._id %>">
    </div>
    <% } %>

    <button type="submit" class="button">Record Race</button>
</form>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        function toggleTimeInputs(selectElement, timeContainerId) {
            const timeContainer = document.getElementById(timeContainerId);
            const inputs = timeContainer.querySelectorAll('input[type="number"]');
            
            if (selectElement.value === 'Finished') {
                timeContainer.style.display = 'block';
                inputs.forEach(input => {
                    input.required = true; // Ensure time inputs are required
                });
            } else {
                timeContainer.style.display = 'none';
                inputs.forEach(input => {
                    input.required = false; // Make sure time inputs are not required
                    input.value = ''; // Clear the value to avoid submission of invalid data
                });
            }
        }

        // Initial state setup for each racer
        toggleTimeInputs(document.getElementById('racer1-status'), 'racer1-time-container');
        document.getElementById('racer1-status').addEventListener('change', function() {
            toggleTimeInputs(this, 'racer1-time-container');
        });

        if (document.getElementById('racer2-status')) {
            toggleTimeInputs(document.getElementById('racer2-status'), 'racer2-time-container');
            document.getElementById('racer2-status').addEventListener('change', function() {
                toggleTimeInputs(this, 'racer2-time-container');
            });
        }

        if (document.getElementById('racer3-status')) {
            toggleTimeInputs(document.getElementById('racer3-status'), 'racer3-time-container');
            document.getElementById('racer3-status').addEventListener('change', function() {
                toggleTimeInputs(this, 'racer3-time-container');
            });
        }
    });
</script>
